<div class="page-layout simple left-sidebar inner-sidebar inner-scroll modal-wrapper grid-container">
    <div class="modal-header accent">
        <div class="modal-header-content">
            <div class="modal-header-title">
                <span>Bill Information</span>
            </div>
            <div class="modal-header-icon">
                <div class="comman-date-container">
                    <div class="comman-date">
                        <app-common-date [screenFrom]="screenFromString"
                            (dateTimeEventEmitter)="getDateTime($event)"></app-common-date>
                    </div>
                    <div class="close-icon">
                        <button mat-icon-button tabIndex="-1" (click)="onClose()" aria-label="Close dialog">
                            <span class="modal-icon">
                                <mat-icon>close</mat-icon>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-body" fusePerfectScrollbar>
        <div class="bill-info-container">
          
                <div fxLayout="column" class="gap-5">
                    <div class="patient-info-container patient-info">
                        <mat-card>
                            <div class="patient-info-box">
                                <div class="patient-info-title border-bottom pb-2">
                                    <span class="h2">Patient Information</span>
                                </div>
                                <div class="patient-info-box my-8">
                                    <div class="patient-info-row row-gap-" fxLayout="row" fxLayoutAlign="space-between">
                                    
                                        <div fxLayout="column" fxLayoutGap="6px">
                                            <div class="patient-col gap-3">
                                                <span class="patient-col-key ">Patient Name</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.RegNo}}-{{advanceData.PatientName}}</span>
                                            </div>
                                            <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%" *ngIf="advanceData.DoctorName">
                                                <span class="patient-col-key ">Doctor Name</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.DoctorName}}</span>
                                            </div>
                                    
                                            <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%" *ngIf="advanceData.DepartmentName">
                                                <span class="patient-col-key ">Department Name</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.DepartmentName}}</span>
                                            </div>
                                    
                                        </div> 
                                   
                                        <div fxLayout="column" fxLayoutGap="6px">
                                            <div class="patient-col gap-3" fxFlex="30%" fxFlex.gt-sm="30%">
                                                <span class="patient-col-key ">BillNo </span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.BillNo}}</span>
                                            </div>
                                            <div class="patient-col gap-3" fxFlex="30%" fxFlex.gt-sm="30%" *ngIf="advanceData.BillTime">
                                                <span class="patient-col-key">BillDate </span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{Date}}</span>
                                            </div>
                                    
                                            <div class="patient-col gap-3" fxFlex="30%" fxFlex.gt-sm="30%" style="color: blue;font-weight: bold;">
                                                <span class="patient-col-key">Net Amount</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.NetPayAmount | currency:"INR":"symbol"}}</span>
                                            </div>
                                        </div>
                                    
                                        <div fxLayout="column" fxLayoutGap="6px">
                                            <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%" *ngIf="advanceData.Age">
                                                <span class="patient-col-key ">Age</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.Age}}</span>
                                            </div>
                                    
                                            <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%">
                                                <span class="patient-col-key ">OPD | IPD No </span>
                                                <span>:</span>
                                                <span class="patient-col-value" *ngIf="advanceData.IPDNo">
                                                    {{advanceData.IPDNo}}</span>
                                                <span class="patient-col-value" *ngIf="advanceData.OPDNo">
                                                    {{advanceData.OPDNo}}</span>
                                            </div>

                                            <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%" *ngIf="advanceData.CompanyName">
                                                <span class="patient-col-key ">Company Name</span>
                                                <span>:</span>
                                                <span class="patient-col-value">{{advanceData.CompanyName}}</span>
                                            </div> 
                                        </div>  
                                    </div>
                                </div>
                            </div>
                        </mat-card>
                    </div>
                    <div class="patient-info-container payment-bill-info">
                        <mat-card>
                            <div class="patient-info-box">
                                <div class="patient-info-title border-bottom pb-2">
                                    <span class="h2">Patient Bill Information</span>
                                </div>
                                <div class="patient-info-box my-8">
                                    <div class="patient-info-row row-gap-4" fxLayout="row wrap">
                                        <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%">
                                            <span class="patient-col-key ">Bill Amount</span>
                                            <span>:</span>
                                            <span class="patient-col-value gap-4" fxLayout="row">
                                                {{netPayAmt | currency:"INR":"symbol"}}
                                            </span>
                                        </div> 
                                        <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="25%">
                                            <span class="patient-col-key">Bill Date</span>
                                            <span>:</span>
                                            <span class="patient-col-value gap-4" fxLayout="row">
                                                {{Date}}
                                            </span>
                                        </div>
                                        <div class="patient-col gap-3" fxFlex="50%" fxFlex.gt-sm="35%">
                                            <mat-checkbox fxFlex  [checked]="IsAdv" [(ngModel)]="IsAdv"
                                                (change)="OnAdvAmt($event)">Advance Amount?</mat-checkbox>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </mat-card>
                    </div>
                    <div class="table-container" style="padding: 5px 5px 5px 5px;" *ngIf="IsAdv">
                        <mat-card style="padding: 6px;">
                            <div class="airmid-table-container">
                            <mat-table matSort class="h-120" [dataSource]="dataSource" [@animateStagger]="{value:'50'}" class="airmid-table">

                                <ng-container matColumnDef="Date">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>Date
                                    </mat-header-cell>
                                    <mat-cell *matCellDef="let element" fxHide fxShow.gt-sm> {{element.date | date:'dd/MM/YYYY'}}
                                    </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="AdvanceNo">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>
                                        Advance Id </mat-header-cell>
                                    <mat-cell *matCellDef="let element" fxHide fxShow.gt-sm>
                                        {{element.advanceId}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="AdvanceAmount">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>
                                        Advance Amount </mat-header-cell>
                                    <mat-cell *matCellDef="let element" fxHide fxShow.gt-sm>
                                        {{element.advanceAmount | currency:'INR'}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="UsedAmount">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>
                                        Used Amount </mat-header-cell>
                                    <mat-cell *matCellDef="let element; let i = index" fxHide fxShow.gt-sm>
                                        <!-- {{element.UsedAmount | currency:'INR'}} -->
                                        <!-- [readonly]="element.BalanceAmount == 0" --> 
                                            <mat-form-field appearance="fill">
                                                <input matInput type="text" OnlyNumber [(ngModel)]="element.usedAmount" [value]="element.usedAmount"
                                                    (keyup)="onKeyAdv(element,$event)" (keypress)="keyPressAlphanumeric($event)"
                                                    [disabled]="element.refundAmount == element.advanceAmount"  >
                                            </mat-form-field> 
                                    </mat-cell>
                                </ng-container> 

                                <ng-container matColumnDef="BalanceAmount">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>
                                        Balance Amount </mat-header-cell>
                                    <mat-cell *matCellDef="let element" fxHide fxShow.gt-sm>
                                        {{element.balanceAmount | currency:'INR'}} </mat-cell>
                                </ng-container> 

                                <ng-container matColumnDef="RefundAmount">
                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxHide fxShow.gt-sm>
                                        Refund Amount </mat-header-cell>
                                    <mat-cell *matCellDef="let element" fxHide fxShow.gt-sm>
                                        {{element.refundAmount | currency:'INR'}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="loading">
                                    <mat-footer-cell *matFooterCellDef colspan="6">
                                        <mat-spinner [diameter]='30'></mat-spinner>
                                    </mat-footer-cell>
                                </ng-container>

                                <ng-container matColumnDef="noData">
                                    <mat-footer-cell *matFooterCellDef colspan="6">
                                        No data found...
                                    </mat-footer-cell>
                                </ng-container>

                                <mat-header-row class="accent" *matHeaderRowDef="displayedColumns; sticky: true">
                                </mat-header-row>
                                <mat-row *matRowDef="let row; columns: displayedColumns;" class="element"
                                    [@animate]="{value:'*',params:{y:'100%'}}"></mat-row>
                                <mat-footer-row *matFooterRowDef="['loading']"
                                    [ngClass]="{'hide':!(isLoading=='loading')}">
                                </mat-footer-row>
                                <mat-footer-row *matFooterRowDef="['noData']"
                                    [ngClass]="{'hide':!(isLoading=='no-data')}">
                                </mat-footer-row>
                            </mat-table>
                            </div>
                            <div class="net-amt">
                                <span class="net-amt-label">Total UsedAmt:</span>&nbsp;
                                <span class="net-amt-value" style="font-weight:bold;color: blue;">{{getAdvanceSum(dataSource.data) |
                                    currency:'INR' }}</span>
                            </div>
                        </mat-card>
                        <!-- <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" [pageSize]="10" showFirstLastButtons></mat-paginator> -->
                    </div>
                    <div class="patient-info-container payment-detail">
                        <mat-card>
                            <form [formGroup]="patientDetailsFormGrp" class="mat-form-field-auto mat-error-fix">
                                <div class="patient-info-box">
                                    <div class="patient-info-title border-bottom pb-2">
                                        <span class="h2">Payment Details</span>
                                    </div>
                                    <div class="patient-info-box my-8">
                                        <div fxLayout="column" class="patient-details" fxLayoutGap="15px">
                            
                                            <div fxLayout.gt-sm="row" fxLayout="column" class="payment-container gap-8" fxLayoutALign="start start">
                                                <mat-form-field appearance="outline" fxFlex>
                                                    <mat-label>Payment Type</mat-label>
                                                    <mat-select formControlName="paymentType1" (selectionChange)="onChangePaymentType()"
                                                        [(ngModel)]="selectedPaymnet1" required>
                                                        <mat-option *ngFor="let ele of paymentArr1" [value]="ele.value">
                                                            {{ele.viewValue}}
                                                        </mat-option>
                                                    </mat-select>
                                                    <div *ngIf="submitted && f.paymentType1.errors" class="invalid-feedback">
                                                        <div *ngIf="f.paymentType1.errors.required">Payment type is required
                                                        </div>
                                                    </div>
                                                </mat-form-field>
                            
                                                <mat-form-field appearance="outline" fxFlex>
                                                    <mat-label>Amount</mat-label>
                                                    <input matInput formControlName="amount1" (keyup)="GetAmt()" [(ngModel)]="amount1" required
                                                        [readonly]="MulPaySettleAmt" (keypress)="keyPressAlphanumeric($event)">
                                                    <div *ngIf="submitted && f.amount1.errors" class="invalid-feedback">
                                                        <div *ngIf="f.amount1.errors.required">Amount is required</div>
                                                    </div>
                                                    <div *ngIf="IsMoreAmt" class="invalid-feedback">
                                                        <div>Entered Amount must not be greater than Net Amount. </div>
                                                    </div>
                                                </mat-form-field>
                            
                                                <ng-container *ngIf="selectedPaymnet1 != 'cash' && selectedPaymnet1 != 'tds'">
                                                    <mat-form-field appearance="outline" fxFlex>
                                                        <mat-label>Reference Number</mat-label>
                                                        <input matInput formControlName="referenceNo1" placeholder="Card Number" required
                                                            max="999999999999" min="100000000000" autocomplete="off" maxlength="12" minlength="4"
                                                            oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1').slice(0, 12);"
                                                            required="required" value="987665868822">
                                                        <div *ngIf="submitted && f.referenceNo1.errors" class="invalid-feedback">
                                                            <div *ngIf="f.referenceNo1.errors.required">Reference No is
                                                                required</div>
                                                        </div>
                                                    </mat-form-field>
                            
                                                    <!-- <mat-form-field appearance="outline" fxFlex
                                                                                *ngIf="selectedPaymnet1 !='upi'">
                                                                                <mat-label>Bank Name</mat-label>
                                                                                <input matAutocompletePosition="below" type="text"
                                                                                    placeholder="Select BankName" matInput
                                                                                    formControlName="bankName1" [matAutocomplete]="autoBank1"
                                                                                    required>
                                                                                <span matSuffix style="display: flex;">
                                                                                    <mat-icon class="mat-icon-close"
                                                                                        (click)="patientDetailsFormGrp.get('bankName1').setValue(''); isBank1elected = false;">close</mat-icon>
                                                                                    <mat-icon class="mat-icon-close"
                                                                                        (click)="patientDetailsFormGrp.get('bankName1').setValue(''); isBank1elected = false;">search</mat-icon>
                                                                                </span>
                                                                                <mat-autocomplete #autoBank1="matAutocomplete"
                                                                                    [displayWith]="getOptionTextBank1">
                                                                                    <mat-option *ngFor="let option of filteredOptionsBank1 | async"
                                                                                        [value]="option">
                                                                                        {{option.BankName}}
                                                                                    </mat-option>
                                                                                </mat-autocomplete>
                                                                                <div *ngIf="submitted && f.bankName1.errors"
                                                                                    class="invalid-feedback">
                                                                                    <div *ngIf="f.bankName1.errors.required">Bank is required</div>
                                                                                </div>
                                                                            </mat-form-field> -->
                                                    <div *ngIf="selectedPaymnet1 !='upi'">
                                                        <airmid-dropdown label="Bank Name" formControlName="bankName1"
                                                            [formGroup]="patientDetailsFormGrp" [validations]="getValidationMessages().bankName1"
                                                            (selectionChange)="selectChangebank($event)" [mode]="autocompleteModebank">
                                                        </airmid-dropdown>
                                                    </div>
                            
                            
                                                    <mat-form-field appearance="outline" fxFlex>
                                                        <mat-label>Registration Date</mat-label>
                                                        <input matInput [matDatepicker]="datepickerReg" formControlName="regDate1"
                                                            (click)="datepickerReg.open()" [max]="nowDate">
                                                        <mat-datepicker-toggle matSuffix [for]="datepickerReg"></mat-datepicker-toggle>
                                                        <mat-datepicker #datepickerReg>
                                                        </mat-datepicker>
                                                        <div *ngIf="submitted && f.regDate1.errors" class="invalid-feedback">
                                                            <div *ngIf="f.regDate1.errors.required">Registration Date is
                                                                required</div>
                                                        </div>
                                                    </mat-form-field>
                                                </ng-container>
                                                <div class="btn-container">
                                                    <div class="add-icon-btn" *ngIf="IsAllowAdd()">
                                                        <button class="btn btn-primary"
                                                            [ngClass]="{'btn-disabled': ((netPayAmt-paidAmt) < amount1)}" (click)="onAddPayment()">
                                                            <!-- <mat-icon > add </mat-icon> -->
                                                            +
                                                        </button>
                                                    </div>
                                                </div>
                            
                                            </div>
                                            <mat-table class="sales-table" #table matSort *ngIf="Payments.data.length>0" [dataSource]="Payments"
                                                [@animateStagger]="{value:'50'}" style="overflow:auto;min-height: auto;">
                                                <ng-container matColumnDef="PaymentType">
                                                    <mat-header-cell *matHeaderCellDef class="w-180" mat-sort-header>Payment
                                                        Type</mat-header-cell>
                                                    <mat-cell *matCellDef="let contact" class="w-180">
                                                        <span>{{contact.PaymentType}}</span>
                                                    </mat-cell>
                                                </ng-container>
                            
                                                <ng-container matColumnDef="Amount">
                                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxShow.gt-sm>Amount
                                                    </mat-header-cell>
                                                    <mat-cell *matCellDef="let contact" fxShow.gt-sm>
                                                        {{contact.Amount}}
                                                    </mat-cell>
                                                </ng-container>
                            
                                                <ng-container matColumnDef="BankName">
                                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxShow.gt-sm>Bank
                                                    </mat-header-cell>
                                                    <mat-cell *matCellDef="let contact" fxShow.gt-sm>
                                                        {{contact.BankName ? contact.BankName:'--' }}
                                                    </mat-cell>
                                                </ng-container>
                            
                                                <ng-container matColumnDef="RefNo">
                                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxShow.gt-sm class="w-200">Ref
                                                    </mat-header-cell>
                                                    <mat-cell class="w-200" *matCellDef="let contact" fxShow.gt-sm>
                                                        {{contact.RefNo ? contact.RefNo:'--' }}
                                                    </mat-cell>
                                                </ng-container>
                            
                                                <ng-container matColumnDef="RegDate">
                                                    <mat-header-cell *matHeaderCellDef mat-sort-header fxShow.gt-sm>Reg Date
                                                    </mat-header-cell>
                                                    <mat-cell *matCellDef="let contact" fxShow.gt-sm>
                                                        {{contact.RegDate| date:ShortDate}}
                                                    </mat-cell>
                                                </ng-container>
                                                <ng-container matColumnDef="buttons" stickyEnd>
                                                    <mat-header-cell *matHeaderCellDef class="table-actions">Action
                                                    </mat-header-cell>
                                                    <mat-cell *matCellDef="let contact">
                                                        <ng-container class="actions">
                                                            <!-- <span class="material-icons" (click)="editTableRow(contact)" style="cursor: pointer;color: #5b5858;">
                                                                                        edit
                                                                                    </span> -->
                                                            <span class="material-icons" style="cursor: pointer;color: #5b5858;"
                                                                (click)="deletePayment(contact)">
                                                                delete
                                                            </span>
                                                        </ng-container>
                                                    </mat-cell>
                                                </ng-container>
                                                <mat-header-row class="accent" *matHeaderRowDef="selectedSaleDisplayedCol; sticky: true">
                                                </mat-header-row>
                                                <mat-row *matRowDef="let contact; columns: selectedSaleDisplayedCol;"
                                                    [@animate]="{value:'*',params:{y:'100%'}}"></mat-row>
                                            </mat-table>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </mat-card>
                    </div>
                    <div class="patient-info-container paid-amount">
                        <mat-card>
                            <form [formGroup]="patientDetailsFormGrp" class="mat-form-field-auto mat-error-fix">
                                <div class="patient-info-box">
                                    <div class="patient-info-title border-bottom pb-2">
                                        <span class="h2">Paid Amount</span>
                                    </div>
                                    <div class="patient-info-box my-8">
                                        <div fxLayout.gt-sm="row" fxLayout="column" class="gap-8">
                                            <mat-form-field appearance="outline" fxFlex>
                                                <mat-label>Paid Amount</mat-label>
                                                <input matInput formControlName="paidAmountController" [(ngModel)]="paidAmt" readonly>
                                            </mat-form-field>
                                            <mat-form-field appearance="outline" fxFlex>
                                                <mat-label>Balance Amount</mat-label>
                                                <input matInput formControlName="balanceAmountController" [(ngModel)]="balanceAmt" readonly>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </mat-card>
                    </div>
                </div> 
        </div>
    </div>
    <div class="modal-footer">
        <div class="footer-navigation-container">
            <div class="modal-footer-buttons">
                <button class="btn btn-danger-outline " (click)="onClose1()">Close</button>
                <button class="btn btn-primary"  (click)="onSubmit()">Save</button>
            </div>
        </div>
    </div>
</div>